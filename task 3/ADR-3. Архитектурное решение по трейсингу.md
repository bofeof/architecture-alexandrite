# ADR-3. Архитектурное решение по трейсингу

## Статус  
Предложение (Draft)

## Категория
Планирование

## Контекст

Система "Александрит" представляет собой распределенную архитектуру с сервисами витрины магаизина, расчетной частью MES, CRM, очередью сообщений и БД. Процесс покупки и оформления заказа затрагивает несколько систем, обмен между которыми осуществляется как синхронно (REST), так и асинхронно (очереди сообщений). При расширении производства компания столкнулась с проблемами в цепочке формирования заказа и сейчас невозможно быстро установить, на каком этапе возникла ошибка или зависание.

## Решение

В систему будет внедрен трейсинг на базе OpenTelemetry. Визуализация трейсинга будет производиться через Jaeger. Хранение данных в БД по трейсингу будет представлено в ClickHouse. Также предлагается связять Jaeger  и Grafana вместе, чтобы быстрее переходить от метрик к трейсам.


### Компоненты, подлежащие трейсингу:

* Сервис MES
* Сервис CRM
* Сервис Shop
* Очередь сообщений (RabbitMQ)

### Используемые технологии и связи:

* OpenTelemetry SDK (OTel SDK) во всех сервисах
* OpenTelemetry Collector для централизованного сбора для метрик и трейсинга. Cлужит дополнительно маршрутизатором данных в Jaeger и Prometheus
* Jaeger для визуализация и хранение спанов
* Prometheus + Grafana - инструменты для метрик, мониторинга и алертинг
* Jaeger  + Grafana - чтобы быстрее переходить от метрик к трейсам.
* Alertmanager - оповещение по метрикам и отклонениям

### Данные трейсов и спанов:

|Группа спанов| Назначение |
|---|---|
|trace_id, span_id, parent_id| уникальные id для трейсинга|
|request_id, user_id, order_id, model_id| id в рамках бизнес-контекста|
|service.name, host.name |источники, откуда пришел трейс со спаном|
|time_start, time_end, duration|время выполнения и продолжительность операции|
|status: OK или ERROR|статус операции|
|exception.message|сообщение об ошибке|
|http.method, http.url, http.status_code|детализация по API запросу|
|net.peer.name, messaging.system, messaging.destination, messaging.operation, messaging.message_id|для отслеживания действий в RabbitMQ|
|queue.delay.ms, processing.time.ms|измерение задержки сообщений|
|db.system, db.statement, db.operation, db.name| работа с БД|
|deployment.environment|окружение разработки|
|retry.count|попытки |

## Последствия

* Плюсы:
    * Повышение прозрачности и скорости диагностики инцидентов
    * Возможность анализа производительности на каждом этапе прохождения заказа
    * Анализ и поддержка метрик SLA, SLO по трейсам
    * Возможность связанно исследовать трейсы и мониторинг, оповещать о проблемах

* Минусы:
    * Рост нагрузки на инфраструктуру
    * Требуются доработки сервисов для передачи дополнительных данных в трейс
    * Увеличение затрат из-за расширения инструментов в архитектурном решении, добавятся: Jaeger,  OTEL, ClickHouse
    * Сложность внедрения незнакомых технологий, нужно обучение, менторинг команд, нужна документация.

## Вопросы безопасности

* Доступ к Jaeger и OTEL Collector с учетом управления ролей RBAC, доступ к данным по внутренней корп сети или VPN
* Взаимодейтсивя через gRPC c использованием mTLS протокола
* Аутентификация через SSO
* Исключение персональных данных из трейсов и\или маскирование персональной информации. Альтернативный вариант - разделить детализацию трейсов по стендам разработки, на прод.окружении чувствительные данные скрыть.

## Альтернативы

* Использовать только логирование и базовый мониторинг без распределенного трейсинга - не показывает полной картины провалов в работе ПО
* Использовать Zipkin - менее гибкая интеграция и визуализация по сравнению с Jaeger и ClickHouse
* Использовать Elasticsearch - сложнее и дороже во внедрении, чем ClickHouse

## Мониторинг и алертинг (дополнительно)

* OTEL Collector экспортирует метрики в Prometheus
* Grafana визуализирует данные из Prometheus
* Grafana и Jaeger  общаются друг с другом через trace_id, коммуникация идет через HTTP API Jaeger 
* Alertmanager генерирует оповещения в каналы связи из Prometheus

## Ссылки на диаграммы
* [Диаграмма C4 с компонентами трейсинга + мониторинга + алертинга](./jewerly_c4_model%20+%20tracing.drawio.svg)
* Нововведения и предложения выделены красным цветом.
