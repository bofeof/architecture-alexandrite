# ADR-2: Выбор и настройка мониторинга в компании "Александрит"

## Контекст

Сайт компании "Александрит" подключен к Яндекс Метрике. С тех пор, как бизнес начал предоставлять оформление заказов через API, данные Яндекс Метрики уже не дают полной картины. Это означает, что бизнес и технические службы не получают полную картину поведения системы.
Для обеспечения стабильной работы, быстрого реагирования на сбои и анализа производительности необходима реализация полноценного мониторинга.

## Мотивация

- Повышение прозрачности работы сервиса. Сейчас бизнес видит только фронт часть, но не контролирует бэк, т.е. то, что происходит при оформлении заказа через API. Необходимо видеть полную картину при работе с системой.
- Своевременная реакция на сбои в работе системы. Без мониторинга инциденты выявляются только по жалобам и по фактическому оттоку клиентов.
- Доказательная база для разбора инцидентов среди технических команд. Конкретные метрики и графики позволяют объективно оценить ситуацию во времени и предвидеть типовые ошибки. Для стабильной работы сервиса и технической поддержке в режиме 24/7, нужно собирать метрики, визуализировать их динамику (в дашбордах и графиках), анализировать результаты и работать с инцидентами и желательно до того, как они стали инцидентами.
- Доказательная база для пересмотра архитектуры при дальнейших изменениях продукта.
- Оптимизация ресурсов. Мониторинг определит узкие места и позволит принимать решения о масштабировании.

## Выбор подхода к мониторингу
Предлагатся подойти к созданию мониторинга с позиции нескольких методологий сразу.

- Для мониторинга пользовательских и инфраструктурных рисков предлагается использовать LTES "Четыре золотых сигнала" (Latency, Traffic, Errors, Saturation).
- Для работы с очередью RabbitMQ, БД будет использоваться USE-модель (Utilization, Saturation, Errors).

Ниже предложен первоочередный набор метрик, который может дополняться.


## Метрики и зоны отслеживания

### Мониторинг очереди RabbitMQ

| Метрика | Ярлыки | Значение и определение метрики |
|---|---|---|
|RabbitMQ queue messages |label (название очереди), message_type (тип сообщения), producer, consumer| Общее количество сообщений в очереди|
| Number of message in flight in RabbitMQ | label (название очереди), message_type (тип сообщения), delivery_status, producer, consumer | Количество сообщений, которые были доставлены потребителю, но еще не подтверждены (acknowledged). Отслеживание перегрузки или "застревания" сообщений |
| Number of dead-letter-exchange mwssages in RabbitMQ | label (название очереди), message_type (тип сообщения), producer, consumer, headers.x-death.reason из заголовка сообщения  | Выявление сообщений, которые не обработались корректно и с ошибками пересены в "отстойник" DLX -> DLQ. В этой метрике наблюдаем за сигналом ошибки|
| Number of message in DLQ |label (название очереди), message_type (тип сообщения), producer, consumer, headers.x-death.reason из заголовка сообщения|Общее количество сообщений с ошибками в "отстойнике" DLQ. Потенциально может помочь при сверке сообщений в переходах между DLX и DLQ, удостовериться, что сообщения не теряются и роутинг корректный. В этой метрике наблюдаем за сигналом накопления ошибочных сообщений|
| Retries / Redeliveries|label (название очереди), message_type  (тип сообщения), producer, consumer, retry_count, retry_reason (headers.x-death) |Повторные попытки обработки. Cигнал о нестабильности или падениях при обработке.|
| RPS publish | label (название очереди), message_type (тип сообщения), producer | Количество сообщений, публикуемых в очередь в секунду |
| RPS consume | label (название очереди), message_type (тип сообщения), consumer | Количество сообщений, потребляемых из очереди в секунду |

---

### API\sevices

#### Shop API, CRM API, MES API

| Метрика | Ярлыки | Значение и определение метрики |
|---|---|---|
| Number of requests (RPS) | path (путь), method (метод), status_code (результат), user_id | Общее количество запросов в секунду. Используется для оценки нагрузки на API и обнаружения пиков трафика |
| Number of requests per user (RPS) | user_id, ip | Количество запросов от конкретного пользователя. Помогает выявлять аномальное или вредоносное поведение, атаки |
| Response time (latency) | path, method, user_id, status_code | Время ответа API. Ключевой показатель производительности. Рост латентности сигнализирует о деградации сервиса |
| Number of HTTP 200 / 500 | path, method / endpoint, system (shop / CRM / MES), user_id | Количество успешных (200) и ошибочных (500+) ответов. Позволяет контролировать корректность работы API |
| CPU % / Memory Utilisation | instance, service_name (Shop API, CRM API, MES API) | Нагрузка на процессор и потребление памяти на уровне сервиса. Помогает выявлять узкие места и утечки |
| Number of simultaneous sessions | service_name, application, role (user / operator) | Количество активных одновременных сессий. Оценивает живую нагрузку и количество одновременных подключений |
| Kb transferred / Kb provided | endpoint, user_id | Объем переданных и полученных данных. Помогает анализировать сетевую активность и потенциальные проблемы с трафиком |
| Concurrent requests | path, method, service_name | Количество одновременно обрабатываемых запросов. Может быть индикатором перегрузки или неэффективности обработки |
| Queue time (if using async) | path, method, service_name | Время, которое запрос провел в очереди перед обработкой (например, в воркере, брокере или task queue). Полезно для асинхронных API |
| Error rate (%)| endpoint, service_name, status_code | Доля неуспешных запросов для контроля стабильности и корректности сервиса. |
| Availability / Uptime (%) |service_name| Процент времени доступности сервиса. Ключевой показатель SLA|
| Mean Time To Recovery (MTTR) | service_name| Среднее время восстановления сервиса после сбоя. Важный SLA-показатель|
| Timeouts| endpoint, service_name, user_id| Количество запросов, завершившихся таймаутом. Сигнал о проблемах с производительностью |


### Базы данных

| Метрика | Ярлыки | Значение и определение метрики |
|---|---|---|
| Memory Utilisation for DBs| db_instance, service_name (Shop DB, MES DB) | Используется для выявления утечек памяти и оценки нагрузки на базу данных. Помогает предотвратить деградацию производительности и сбои |
| Number of connections| db_instance, service_name| Количество активных подключений к базе данных. Помогает предотвратить преполнение лимита подключений|
| Size of DB| db_instance, service_name| Объем данных в базе. Поможет принимать архитектурные решения по шардированию, репликации и масштабированию|
| Cache hit ratio | db_instance, service_name| Процент попадания запросов в кеш. Помогает оценить эффективность кеширования и производительность базы данных|
| Disk I/O utilization| db_instance, service_name| Использование дисковой подсистемы. Высокие значения могут указывать на узкие места и влиять на скорость обработки запросов|
| Number of slow queries| db_instance, query_type, service_name | Количество запросов, которые выполняются дольше заданного порога. Позволяет выявлять медленные запросы|
---

### Определение коэффициентов насыщенности
Необходимо обсудить с командой. Примеры предложений
|Метрика|Пороговое значение| Мотивация|Потенциальные действия|
|---|---|---|---|
|Cache hit ratio| <70% за месяц| Низкий уровень попадания в кеш сигнализирует о неэффективной стратегии кеширования и TTL кеша|Отправка алерта в выбранный канал связи на проверку работы кеширования и интеграции с БД|
|Availability / Uptime (%)| <99% за месяц |Нарушение SLA и снижение доверия к системе|Оповещение + Тикет jira для DevOps|
|CPU % / Memory Utilisation| >85% за час | Превышение по загрузке приведет к торможению и сбоям приложений|Перезапуск сервера + оповещение по каналу связи. При возникновении частых проблем на одном и том же участке - тикет jira для DevOps|
|Number of slow queries| >30% от всех запросов за сутки |Превышение приведет к отказу в обслуживании и плохому UX|Оповещение в канал связи о необходимости аудита и оптимизации запросов к БД|

---
## Верхнеуровневый план действий
Реализация системы мониторинга в компании "Александрит"
1. Аудит и планирование:
- Провести инвентаризацию сервисов и инфраструктуры
- Зафиксировать список метрик и целевых SLA, SLO
- Согласовать список метрик и их ярлыков для улучшения качества фильтрации данных

2. Выбор технологий
- Выбрать time-series БД (Prometheus)
- Выбрать систему визуализации и алертинга (Grafana и Alertmanager + Prometheus)
- Определить формат сообщений и каналы для оповещений (почта, мессенджеры)

3. Развертывание базовой инфраструктуры
- Настройка ядра мониторинга: создать инстансы Prometheus и Grafana
- Настроить retention, репликацию. Обсудить необходимость шардирования и добавить в реализацию при согласовании.
- Установить и развернуть экспортеры на хостах, добавить ярлыки: node-exporter (сбор метрик с CPU, RAM, дисков, сети) и системные экспортеры (процессы, СУБД, API)
- Для системных экспортеров
  - для RabbitMQ (rabbitmq_exporter)
  - для БД (postgres_exporter)
  - для API через middleware, custom metrics

5. Метрики и алерты. Настроить метрики согласно предложенным таблицам выше.
- Добавить алерты по SLO:
  - error rate > threshold
  - latency > threshold
  - db connections > limit
  - high memory / CPU usage

6. Визуализация в Grafana-дашбордах: API (Shop, CRM, MES), RabbitMQ, БД, инфраструктура. Настроить фильтрацию по лейблам.

7. Документация и проведение тренингов по мониторингу командам поддержки и разработки

8. Развернуть мониторинг на стендах разработки и тестирования. Провести тестирование.

9. Перевод разработок на прод. стенд

## Инструменты
* Prometheus + Grafana - основной стек мониторинга.
* Alertmanager - для настройки оповещений
