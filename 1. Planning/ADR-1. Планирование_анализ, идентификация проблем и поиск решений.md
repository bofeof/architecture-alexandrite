# ADR-1: Планирование: анализ, идентификация проблем и поиск решений в компании "Александрит"

## Статус  
Предложение (Draft)

## Категория
Планирование

## Контекст  
Компания столкнулась с критическими проблемами в своем продукте:
- Просроченные заказы (B2B, B2C сегменты).
- Отказ клиентов от продукта (B2B, B2C сегменты).
- Низкая масштабируемость при растущей нагрузке.
- Монолитный MES и его производительность (долгие расчеты, медленный отклик от UI).
- Проблема коммуникации между MES и CRM через брокер.
- Потеря заказов.
- Отсутствие автоматизированного CI/CD.
- Задержки в релизах.

Монолитное решение MES больше не справляется с нагрузкой со стороны B2B, B2C и требует пересмотра архитектуры, подходов к деплою и используемых технологий.

## Решение  

### Проблемные зоны

| Проблема | Влияние |
|---------|---------|
| Монолитный MES | Высокая нагрузка, долгие расчеты, зависания, сложно масштабировать |
| Деплой монолитов в облаке| Высокие денежные затраты при попытке масштабироваться |
| Количество инстансов | Низкая отказоусточивость при высоких нагрузках |
| B2B и B2C потоки не разделены | B2B и B2C вместе перегружают текущие единые ресурсы |
| Медленный отклик UI MES | Операторы не видят новые заказы, снижается мотивация |
| Нет автотестов и не настроен CI\CD | Задержки релизов, ошибки в проде. Обновления могут полностью остановить работу приложения по человеческой неосторожности |
| Коммуникация MES и CRM через RabbitMQ | Очереди не масштабируются, не контролируются, сообщения теряются |
| Нет мониторинга, алертинга | Бизнес узнает о проблемах только от клиентов |

---

### Инициативы и приоритеты

Далее пункты можно расписать отдельными ADR, подробное описание не предусмотрено в текущем ADR.

#### Очень высокий приоритет (выполнить в ближайшие 4 месяца)

1. Выделить сервис расчета стоимости из MES
- Асинхронный микросервис.
- Возможность масштабировать независимо (возможно, сделать в перспективе для B2B и B2C отдельные инстансы и сразу перенаправлять трафик в них).
- Выделить API Gateway для растущей распределенной системы. Например, использовать Kong

2. Оптимизация бэкенда и запросов к БД
- Пересмотреть текущие запросы бэкенда к БД
- Разгрузить вычисления фильтрации на UI, если сейчас это делается на клиенте. Добавить индексы, денормализовать таблицы для ускорения чтения (последний пункт требует доп. анализа)
- Rate limiting + Burst limiting (для возможности контролировать всплески активности). Установить разные лимиты для разных сегментов - B2B, B2C
- Установить приоритеты в запросах
- Реализация паттерна Circuit Breaker
- Троттлинг публичного API для предотвращения перегрузов системы

3. Повышение качества наблюдаемости
- Внедрение инструментов для повышения наблюдаемости, например, ELK\OpenTelemetry.
- Оповещения\алертинг для DevOps и техподдержки.


#### Высокий приоритет (выполнить в ближайшие 6 месяцев)

4. Кэширование заказов и расчетов при работе с MES
- Показывать только активные и\или новые заказы в UI.
- Кешировать однотипные модели расчетов в MES
- Рассмотреть клиентское и серверное кеширование для разных операций

5. Разделить потоки B2C и B2B бизнеса в RabbitMQ
- Отдельные очереди для разных клиентских сегментов.
- Реализация паттерна Backpressure


#### Средний приоритет

6. Репликация БД
7. Переход на модель работы с БД read-replica, если запросов на чтение и получение данных больше записи.
7. Горизонтальное масштабирование MES и CRM инстансов.
8. Внедрение CI/CD и автотестов. Минимальное участие людей в данных процессах.
9. Пересмотр стратегии релизов продукта: посмотреть в сторону канареечного релиза, например.
10. Полная миграция в Ya.Cloud вместо AWS EC2, чтобы весь продукт был в одном месте.

---

### Альтернативы, которые рассматривались

- Продолжить расширение по EC2 модели в облаке - с учетом, что деплоятся монолиты, такое решение можно рассматривать только как временное, очень дорогое в облуживании в перспективе. 
- Убрать публичное API, чтобы снизить нагрузку — потеря клиентов.

---

### Целевая архитектура через 6 месяцев

- Расчетный сервис MES масштабируется независимо.
- Очереди изолированы по бизнес-сегментам и контролируются.
- MES не занимается вычислениями на клиентской части, а лишь отдает результаты, что делает его быстрым для работы.
- Оптимизирована работа бекенда и запросов к БД
- Автотесты запускаются в CI/CD
- Релизы стабильные, ошибки не останавливают полностью работу сервиса.
- Улучшена наблюдаемость работы продукта, команды поддержки и разработки сразу получают информацию о возникших проблемах

---

## Последствия

| Позитивные | Негативные |
|-----------|------------|
| Увеличение производительности и надежности | Требуется перераспределение ресурсов. Может потребоваться наем дополнительных сотрудников, чтобы успеть закрыть все работы в срок |
| Повышение удовлетворенности пользователей и клиентов | Необходима адаптация команд разработки и поддержки |
| Повышение гибкости архитектуры и масштабируемости | Временные затраты на разработку, автоматизацию |