# ADR-5. Архитектурное решение по кешированию

## Статус
Предложение (Draft)

## Категория
Планирование

## Контекст
Система "Александрит" представляет собой распределенную архитектуру с сервисами витрины магазина, работой с расчетами заказов в MES, CRM, очередью сообщений и БД. При расширении производства компания столкнулась с проблемами в цепочке формирования заказа и конечной ценности для пользоваеля.

Самым слабым местом в системе является работа с MES при создании заказов и расчета моделей - недовольны работой операторы и внешние потребители сервиса, основные причины: долгие расчеты заказа\модели, тормозящий UI.  Торможение MES может вызвать снижение производительности в CRM и Shop, так как MES тесно взаимодействует с этими системами при прогрузке и создании заказа. Одним из решений по оптимизации работы и улучшения качества UX является кеширование.

## Мотивация
Внедрение кеширования даст компании:
- Ускорение работы MES, увеличение удовлетворенности от UX зависимых систем
- Ускорение отдачи ответов при однотипных запросах от клиентов, операторов - UI перестанет долго рендерить результаты
- Ускорение расчета модели заказа
- Появится возможность горизонтально масштабировать CRM, MES, Shop, делая все приложение более отказоусточивым при постоянно растущей нагрузке

Элементы системы "Александрит", которые будут включены в кеширование:
- Система MES: работа с дашбордом для операторов, данные расчета модели (полигоны, прочие характеристики, влияющие на итоговую цену).
- CRM и Shop: работа с результатами поиска, уже оформленных заказов, ЛК клиентов, справочная информация

## Предлагаемое решение
Данные предлагается кешировать и на серверной, и на клиентской части. Все зависит от веса операций - тяжелые вычисления необходимо вынести в серверное кеширование, справочная информация уходит на клиентскую часть.

* Клиентское кеширование:
    - Результаты последней фильтрации конкретного пользователя по заказам и каталогу
    - Показ результатов по оформленным заказам
    - ЛК
    - Справочная информация для конкретного пользователя
* Серверное кеширование
    - Вычисления моделей в MES
    - Параметры детали\заказа для вычислений.
    - Показ всех заказов для оператора и результаты фильтрации в дашборде (самые актуальные заказы в начале списка).
    - Показ отфильтрованного дашборда для оператора

## Паттерны кеширования

* Для клиентского кеша выбрать Cache Aside с поддержкой SWR (SWR позволяет обслуживать устаревший ответ во время повторной проверки кеша в фоновом режиме) даст наилучший UX, т.к. быстро и незаметно для пользователя.
* Для серверного кеша выбрать стратегии Write-Through (для расчетов) + Read-Through (для фильтров/дашбордов) - это обеспечит баланс между производительностью и актуальностью.

* Клиентское кеширование
    - Read aside + Stale-While-Revalidate (SWR) - быстрый отклик за счет локального кеша, нет блокировок UI, пользователь моментально может получить результат и не заметить долгих прогрузок новых данных. Можно задействовать на клиентской части localStorage, sessionStorage, работа с глобальным контекстом, например, RTK
    - Альтернативы, которые не подошли - Read through - скорость получения данных медленнее, так как при кеш-промахе клиенту нужно обращаться к БД, далее данные запишутся в кеш и только после попадут на клиента. В Read aside доставка контента происходит сразу при промахе - т.е. из БД контент уходит сначала на клиента и только после доставки кеш обновляется, для улучшения UX этот вариант более предпочтительный

* Серверное кеширование
    - Расчеты и информация по модели (MES) с использованием Write-Through, подход обеспечит свежесть данных и простую запись. Данные важны для переиспользования, срок жизни кеша позволит пользователям легко получать расчеты по уже имеющимся данным модели.
    - Дашборды, фильтрация - Read aside (аргументация выбора такая же как и при клиентском кешировании - скорость доставки важна)
    - Получение общего контента - Read-Through. Если сравнивать с дашбордами, то скорость отдачи в данном случае не так критична, при кеш-промахе данные могут пройти через кеш от БД, прежде чем попадут к клиенту.
    - Реализацию кеширования на серверной стороне можно осуществить с помощью Redis


## Инвалидация по ключевым сущностям кеша
|Объект|TTL и инвалидация| Паттерн| Комментарий|
|---|---|---|---|
|Расчет модели (MES)|30 дней \ либо инвалидация происходит по запросу на сервер| Write-Through|Часто переиспользуется, важна актуальность|
|Параметры заказа/деталей|30 дней \ либо инвалидация происходит по запросу на сервер| Read Aside|Менее изменчивые данные, но хранение вместе с расчетом модели |
|Дашборды операторов| 15 минут \ либо инвалидация происходит по запросу на сервер| Read Aside|Часто обновляются, высокая чувствительность к свежести |
|Общий справочник (CRM/Shop)| 1 день| Read-Through |Регулярные обновления|
|Клиентский кеш (UI)| 10 минут \ либо инвалидация происходит по запросу на сервер при обновлениях информации от клиентов | Read Aside + SWR|Управляется библиотеками или localStorage |


Sequence-диаграмма по работе с кешем.
На схемах показано как проходит операция чтения списка заказов и запись об изменении статуса заказа. 
* ![Чтение заказов](../out/task%205/Sequence_cache_scheme_get_orders/Sequence_cache_scheme_get_orders.svg)
* ![Изменить статус заказа](../out/task%205/Sequence_cache_scheme_change_status/Sequence_cache_scheme_change_status.svg)
