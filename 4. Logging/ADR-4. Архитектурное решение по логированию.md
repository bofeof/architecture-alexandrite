# ADR-4. Архитектурное решение по логированию

## Статус
Предложение (Draft)

## Категория
Планирование

## Контекст
Система "Александрит" представляет собой распределенную архитектуру с сервисами витрины магазина, расчетной частью по заказу MES, CRM, очередью сообщений и БД. При расширении производства компания столкнулась с проблемами в цепочке формирования заказа и конечной ценности для пользоваеля, сейчас невозможно быстро расследовать и установить, на каком этапе возникла ошибка или зависание.

Часть обнаружения проблем с производительностью будет покрыто при помощи мониторинга и трейсинга, но в некоторых местах работы системы требуется максимальная детализация действий. В систему предлагается ввести дополнительный уровень детализации операций - централизованное логирование с использованием Fluent Bit + Loki + Grafana.

## Мотивация
Внедрение централизованного логирования даст компании:
* Повышение наблюдаемости, скорости поиска и диагностики проблем. Повышение прозрачности работы системы (особенно важно логирование при отслеживании создания заказов - сейчас это самое больное место в ПО)
* Снижение нагрузки на службу поддержки, так как наличие развернутых данных позволяет быстрее исследовать инцидент
* Возможность предсказать и отследить аномальное поведение систем, пользователей
* Помощь в тех. аудите и при изменениях в архитектуре - это неизбежно при росте зрелости продукта
* Улучшения показателей метрик таких как MTTR, SLA, доля решенных инцидентов

## Предлагаемое решение

### Приоритетное внедрение
Сначала логирование внедряется в:
* Сервис заказов\MES (основной проблемный сервис по производительности и развитию UX)
* Сервисы CRM, Shop, брокер

### Компоненты логирования:
* Fluent Bit: легкий агент логирования, устанавливается на каждом сервисе
* Loki: хранилище логов, ориентированное на стриминговую природу
* Grafana: визуализация логов с фильтрами, шаблонами и дашбордами, также Grafana помогает закрыть вопрос с оповещением - есть возможность настроить интеграцию с AlertManager

### Системы, в которых будет настроено логирование:
* Shop
* MES
* CRM
* Очередь сообщений (RabbitMQ)

### Необходимые логи
В данном разделе более детально раскрыта часть по логам уровня INFO, остальные уровни представлены для ознакомления и дальнейшего обсуждения.

|Событие|Поля для логирования|Системы сбора логов|
|---|---|---|
|Аутентификация и авторизация|user_id, role, ip|Shop, CRM|
|Создание или изменение сущности клиента|client_id, user_id, operation_type, timestamp|CRM|
|Создание или изменение сущности заказа|order_id, user_id, status, timestamp, user_type|Shop, CRM|
|Создание или изменение сущности модели изделия|model_id, client_id, order_id|CRM, MES|
|Запрос и ответ от CRM|service, endpoint, status_code, response_time|Shop, MES, CRM|
|Вызовы API MES|service, endpoint, status_code, response_time, client_id|MES|
|Начало и завершение обработки любого запроса|trace_id, duration, status|Shop, MES, CRM|
|Работа с сообщениями в очереди|queue_name, message_id, event_type, producer, consumer, status, timestamp|Shop, MES, CRM, RabbitMQ|

* DEBUG (dev стенды):
    - технические детали: структура запроса, передаваемые параметры, результаты SQL-запросов

* WARN (важные логи на текущий момент):
    - медленные запросы, неожиданные входные данные, частичные ошибки, необычная активность пользователя (частые попытки авторизации, быстрая смена ip, попытка открыть несколько сессий), повторы запросов

* ERROR (важные логи на текущий момент):
    - исключения, сбои вызовов, таймауты, падения микросервисов, ошибки интеграции


### Безопасность
* Маскирование, добавление соли полям с чувствительной информацией, например: персональные данные клиента\заказчика, почта, номер телефона, ip и тд
* Доступ к Grafana через SSO c учетом RBAC (ролевые уровни для обсуждения: администратор, аналитик, разработчик)
* Loki доступен только под корпоративной сетью или по VPN
* Информация по логированию подлежит шифрованию во время доставки, каналы должны быть защищены (TLS)

### Политика хранения
* Хранение логов в Loki - 14 дней по умолчанию для INFO, 90 дней для ERROR, WARNING. Сохранение критичных логов сроком на 3 месяца важно для аудита, расследования инцидентов и поиска закономерностей.

## Аналитика логов и алертинг
* В силу того, что Loki не может напрямую работать с AlertManager, а Grafana - да, для оповещения предлагается взять связку Grafana + Alertmanager или настроить алертинг сразу в Grafana (последние версии позволяют заниматься оповещением напрямую). Первый вариант реализации более приоритетный - AlertManager должен стать центральным местом для рассылки уведомлений по мониторингу и логированию.
* Часть оповещений уже покрывается мониторингом, для более точечного уведомления предлагается рассмотреть следующий алертинг по логам. По мере роста продукта, алертинг можно расширить. К обсуждению:
  * Всплески логов с однотипными сообщениями в статусе ERROR: за последние 10 мин их количество увеличилось в 3 раза от среднего показателя за день.
  * Увеличение WARN за 1 час в 5 раз от среднего показателя за месяц (хорошо подойдет для отслеживания тормозов в расчете 3D моделей в MES, подозрительной активности расчета однотипных моделей, т.к. MES и коммуникация с другими сервисами - очень узкое место в продукте)
  * Аномалия по подключениям и попыткам авторизоваться: активность пользователей по user_id, ip, попыткам отправить запрос выросла за 5 мин. в 10 раз (для выявления DDoS, brute force)

## Критерии выбора технологии логирования

| Критерий | Fluent Bit + Loki| ELK |
|---|---|---|
| Простота внедрения| Высокая (особенно с Kubernetes) | Требует настройки индексов|
| Легкость хранения | Эффективная для стриминга | Высокие ресурсы и диск|
| Интеграция с Grafana| Нативная | Через Grafana Data Source |
| Масштабируемость| Высокая| Средняя при больших объемах |
| Поддержка и комьюнити | Активная, CNCF | Зрелое, широкое|

Текущий выбор: Fluent Bit + Loki + Grafana - за счет легкости, гибкости и нативной интеграции. Текущий проект\ПО нельзя считать большим и зрелым, чтобы внедрять ELK-стек: это дольше по времени и дороже.

## Ссылки на диаграммы
* [Диаграмма логирования](./jewerly_c4_model.drawio.svg)
![Диаграмма логирования](./jewerly_c4_model.drawio.svg)